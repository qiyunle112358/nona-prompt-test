# 图片提取功能优化说明

## ✅ 已完成的优化

### 1. 图片提取逻辑改进

**之前的问题：**
- 使用启发式方法判断图片类型（颜色、尺寸等）
- 容易误提取实验图表（折线图、柱状图等）
- 无法准确识别流程图/架构图

**新的方法：**
- ✅ **基于关键词搜索**：在PDF全文中搜索特定关键词
- ✅ **关键词列表**：
  - 英文：`Figure`, `workflow`, `Architecture Diagram`, `Flowchart`, `Experimental Design`, `Technical Roadmap`
  - 中文：`流程图`, `技术路线`, `框架图`, `实验设计`, `示意图`, `工作流程`, `架构图`
- ✅ **智能提取**：找到关键词后，提取该页面附近的图片
- ✅ **优先级排序**：优先提取包含"workflow"、"Architecture"、"流程图"等关键词的图片
- ✅ **自动跳过**：如果论文中没有找到关键词，自动跳过该论文

### 2. Data文件夹整理

**清理内容：**
- ✅ 删除所有 `.DS_Store` 文件
- ✅ 删除临时文件（`temp_*`）
- ✅ 删除重复目录：
  - `original_images/` - 原图已保存在 `results/` 中
  - `generated_images/` - 生成图片已保存在 `results/` 中
  - `images/` - 临时提取的图片

**保留内容：**
- ✅ `results/` - 最终整理的结果（每张原图及其对应的prompt和生成图片）
- ✅ `summary.txt` - 总结报告

**整理结果：**
- 从 32.5 MB 减少到 2.1 MB
- 从 192 个文件减少到 11 个文件
- 结构更清晰，只保留最终结果

## 📋 新的提取流程

```
1. 打开PDF文件
   ↓
2. 在全文范围内搜索关键词
   - Figure, workflow, Architecture Diagram, Flowchart...
   - 流程图, 技术路线, 框架图, 实验设计...
   ↓
3. 如果找到关键词
   ↓
4. 提取关键词所在页面的图片
   ↓
5. 检查图片尺寸（至少200x200像素）
   ↓
6. 返回提取的图片
   ↓
7. 如果没有找到关键词
   ↓
8. 跳过该论文，继续处理下一篇
```

## 🔧 使用方法

### 运行测试

```bash
python scripts/image_prompt_test.py \
    --num-images 2 \
    --year 2024 \
    --num-prompts 5 \
    --openrouter-api-key YOUR_KEY \
    --output-dir data/prompt_test \
    --max-papers 20
```

### 清理data文件夹

```bash
python scripts/cleanup_data.py
```

## 📁 整理后的目录结构

```
data/
├── papers.db              # 数据库
├── pdfs/                  # PDF文件
├── texts/                 # 文本文件（如果有）
└── prompt_test/
    ├── results/           # 最终结果（每张原图及其prompt和生成图片）
    │   ├── <arxiv_id>/
    │   │   ├── original.png
    │   │   ├── generated_1.png
    │   │   ├── generated_2.png
    │   │   ├── generated_3.png
    │   │   ├── generated_4.png
    │   │   ├── generated_5.png
    │   │   └── prompts.txt
    │   └── ...
    └── summary.txt        # 总结报告
```

## ⚠️ 注意事项

1. **关键词匹配**：程序会搜索关键词的**小写形式**，所以大小写不敏感
2. **页面提取**：如果关键词所在页面有多张图片，会提取第一张符合尺寸要求的图片
3. **优先级**：优先提取包含"workflow"、"Architecture"、"流程图"等关键词的图片
4. **自动跳过**：如果论文中没有找到任何关键词，会自动跳过该论文

## 🎯 预期效果

- ✅ 更准确地提取流程图/架构图
- ✅ 避免提取实验图表（折线图、柱状图等）
- ✅ 自动跳过没有相关图表的论文
- ✅ 提高提取质量，减少人工筛选工作

---

**代码已更新，可以直接使用！** 🚀
