# 测试指南

## 测试策略概述

本测试框架采用**渐进式验证**策略，让您可以逐模块测试，每个测试都使用最小化的数据量，避免大批量处理带来的时间和费用成本。

## 测试顺序建议

### 第一阶段：无需网络和API的基础测试（推荐先运行）

```bash
# 1. 配置模块测试 - 验证环境配置
python tests/test_config.py
# 预计耗时: 5秒
# 验证: 路径配置、环境变量、API密钥是否配置

# 2. 数据库模块测试 - 验证CRUD操作
python tests/test_database.py
# 预计耗时: 5秒
# 验证: 数据库创建、插入、查询、更新、统计
```

**结果**: 如果这两个测试通过，说明基础配置正确。

---

### 第二阶段：需要网络但不需要API的测试

```bash
# 3. 论文收集器测试 - 只收集3篇论文
python tests/test_collectors.py
# 预计耗时: 30秒
# 数据量: 3篇arXiv论文
# 验证: 数据格式、网络请求、错误处理

# 4. 论文信息获取测试 - 使用3个已知论文
python tests/test_fetchers.py
# 预计耗时: 30秒
# 数据量: 3篇已知论文
# 验证: arXiv和OpenAlex API、信息完整性

# 5. PDF处理器测试 - 处理1个样本PDF
python tests/test_processors.py
# 预计耗时: 20-30秒
# 数据量: 1个PDF（约2MB）
# 验证: 下载、文本转换、幂等性
```

**结果**: 如果这些测试通过，说明网络相关功能正常。

---

### 第三阶段：需要API的测试（会产生费用）

```bash
# 6. AI分析器测试 - 分析2个短文本
python tests/test_analyzers.py --provider openai
# 预计耗时: 20秒
# 数据量: 2个短文本（各约500字）
# API费用: 约$0.01-0.02
# 验证: 相关性判断、评分准确性、总结质量

# 可选：测试Anthropic
python tests/test_analyzers.py --provider anthropic
```

**结果**: 如果测试通过，说明AI分析功能正常。

---

## 一键运行所有测试

```bash
# 运行所有测试
python tests/run_all_tests.py

# 跳过需要API的测试（不产生费用）
python tests/run_all_tests.py --skip-api

# 跳过需要网络的测试（离线测试）
python tests/run_all_tests.py --skip-network
```

## 测试数据量对比

| 测试模块 | 数据量 | 耗时 | 费用 |
|---------|--------|------|------|
| 配置模块 | 0 | 5秒 | $0 |
| 数据库模块 | 4条记录 | 5秒 | $0 |
| 论文收集器 | 3篇标题 | 30秒 | $0 |
| 信息获取器 | 3篇论文 | 30秒 | $0 |
| PDF处理器 | 1个PDF | 30秒 | $0 |
| AI分析器 | 2个短文本 | 20秒 | ~$0.01 |
| **总计** | **最小化** | **~2分钟** | **~$0.01** |

对比实际运行（不推荐）：
- 收集1000篇论文标题：5-10分钟
- 获取1000篇详细信息：30-60分钟
- 下载1000个PDF：2-4小时，约2GB空间
- 分析1000篇论文：1-2小时，约$50-100

## 测试输出说明

每个测试会输出：

```
==============================================================
测试：模块名称
==============================================================

[测试1] 测试项描述
--------------------------------------------------------------
✓ 成功信息
  详细信息...

[测试2] 测试项描述
--------------------------------------------------------------
✗ 失败信息（如果有）

==============================================================
✓ 模块测试通过
==============================================================
```

## 测试文件保存位置

所有测试数据保存在 `tests/temp/` 目录：

```
tests/temp/
├── test_papers.db      # 测试数据库
├── pdfs/               # 测试PDF
│   └── 1706.03762.pdf
└── texts/              # 测试文本
    └── 1706.03762.txt
```

**可以手动检查这些文件验证质量**

## 常见问题

### Q1: 配置测试失败，显示"API密钥未配置"

**A**: 这是警告，不是错误。如果你还没配置API密钥，可以先运行不需要API的测试。

```bash
python tests/run_all_tests.py --skip-api
```

### Q2: 收集器测试失败

**A**: 可能的原因：
1. 网络连接问题
2. 会议网站结构变化
3. API速率限制

**解决方案**: arXiv收集器最稳定。其他会议收集器如果失败，需要手动检查网站。

### Q3: PDF处理器测试很慢

**A**: PDF下载速度取决于网络。如果太慢：
- 等待第一次下载完成
- 再次运行测试会跳过下载（幂等性）

### Q4: AI分析器给出的分数不准确

**A**: 这可能是正常的：
1. 不同的LLM模型有不同表现
2. 提示词可能需要针对你的需求调整
3. 测试用的短文本信息有限

**建议**: 用你自己领域的论文测试，根据结果调整提示词。

## 测试后的下一步

### 如果所有测试都通过：

✅ 系统配置正确，可以开始小批量试运行：

```bash
# 收集10篇论文
python embodied_survey/scripts/collect_titles.py --source arxiv --year 2024
# 在数据库中手动限制为10篇，然后继续后续步骤

# 或使用示例工作流（已内置小批量限制）
python embodied_survey/example_workflow.py
```

### 如果部分测试失败：

1. **配置测试失败**: 检查环境变量配置
2. **数据库测试失败**: 检查磁盘权限
3. **网络相关测试失败**: 检查网络连接和防火墙
4. **API测试失败**: 检查API密钥和额度

## 额外测试选项

### 测试特定的会议收集器

```bash
# 测试NeurIPS收集器
python tests/test_collectors.py --test neurips

# 测试ICLR收集器
python tests/test_collectors.py --test iclr
```

### 测试不同的LLM提供商

```bash
# 测试OpenAI
python tests/test_analyzers.py --provider openai

# 测试Anthropic
python tests/test_analyzers.py --provider anthropic
```

## 性能基准

在标准配置下（普通网络、OpenAI GPT-4o-mini）：

| 操作 | 单个耗时 | 100个耗时 | 1000个耗时 |
|------|---------|----------|-----------|
| 收集标题 | <1秒 | 10秒 | 1分钟 |
| 获取信息 | 1秒 | 2分钟 | 20分钟 |
| 下载PDF | 3秒 | 5分钟 | 50分钟 |
| 转换文本 | 2秒 | 3分钟 | 30分钟 |
| AI分析 | 5秒 | 8分钟 | 80分钟 |

**建议**: 
- 开发阶段：使用10-20篇论文测试
- 小规模运行：100篇论文
- 生产运行：分批处理，每批500-1000篇

## 总结

这个测试框架的设计原则是：

1. ✅ **最小化数据量** - 每个测试只用必要的最少数据
2. ✅ **快速反馈** - 总测试时间<3分钟
3. ✅ **成本控制** - 总API费用<$0.02
4. ✅ **渐进式** - 从简单到复杂，从本地到网络，从免费到付费
5. ✅ **独立性** - 测试代码与运行代码完全分离
6. ✅ **可检查** - 生成的文件可以手动验证质量

通过这个测试框架，你可以在投入大量时间和费用之前，验证系统的每个部分都正常工作。

