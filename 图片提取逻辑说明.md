# 图片提取逻辑说明

## 当前实现方式

### 1. 关键词搜索阶段

**方法**: `search_keywords_in_pdf(doc)`

- 遍历PDF的每一页
- 在每页的文本中搜索指定的关键词（流程图、技术路线、框架图等）
- 如果找到关键词，记录：
  - `page_num`: 页面编号
  - `keyword`: 匹配的关键词
  - `context`: 关键词周围的文本上下文（前后100字符）

**返回**: 包含关键词的页面列表

---

### 2. 图片定位阶段

**方法**: `extract_image_near_keyword(doc, page_num, keyword)`

**当前实现逻辑**:
1. **页面级别定位**: 只定位到找到关键词的**整个页面**
2. **提取所有图片**: 提取该页面的**所有图片**（`page.get_images()`）
3. **顺序遍历**: 按图片在页面中的出现顺序（`img_index`）遍历
4. **返回第一个符合条件的图片**:
   - 尺寸检查：宽度和高度都 >= 200像素
   - 如果找到符合条件的图片，立即返回
   - 如果所有图片都太小，返回None

**问题**: 
- ❌ **没有精确定位**：只是提取页面的第一张符合条件的图片
- ❌ **可能与关键词无关**：图片可能不在关键词附近
- ❌ **没有考虑图片位置**：不知道图片在页面上的实际位置

---

### 3. 优先级处理

**方法**: `extract_flowchart()`

1. 先搜索关键词，得到匹配的页面列表
2. 按优先级处理：
   - **高优先级关键词**: 流程图、架构图、工作流程等
   - **其他关键词**: 其他匹配的关键词
3. 对每个匹配的页面，调用 `extract_image_near_keyword`
4. 如果找到图片，立即返回

---

## 当前定位方式的局限性

### 问题1: 页面级别定位
- 只定位到页面，不定位到页面内的具体位置
- 如果页面有多张图片，可能提取到错误的图片

### 问题2: 没有位置关联
- 不知道图片在页面上的坐标位置
- 不知道图片是否真的在关键词附近

### 问题3: 顺序提取
- 总是提取第一张符合条件的图片
- 可能与关键词无关

---

## 改进建议

### 方案1: 基于坐标的定位（推荐）

```python
def extract_image_near_keyword(self, doc, page_num: int, keyword: str) -> Optional[Path]:
    """
    基于关键词位置提取附近的图片
    """
    page = doc[page_num]
    
    # 1. 获取关键词在页面上的位置（坐标）
    keyword_instances = page.search_for(keyword)
    
    if not keyword_instances:
        return None
    
    # 2. 获取页面上所有图片及其位置
    image_list = page.get_images()
    image_rects = []
    
    for img_index, img in enumerate(image_list):
        xref = img[0]
        # 获取图片在页面上的位置（矩形区域）
        img_rects = page.get_image_rects(xref)
        for rect in img_rects:
            image_rects.append({
                'rect': rect,
                'index': img_index,
                'xref': xref
            })
    
    # 3. 找到距离关键词最近的图片
    best_image = None
    min_distance = float('inf')
    
    for keyword_rect in keyword_instances:
        keyword_center = (
            (keyword_rect.x0 + keyword_rect.x1) / 2,
            (keyword_rect.y0 + keyword_rect.y1) / 2
        )
        
        for img_info in image_rects:
            img_rect = img_info['rect']
            img_center = (
                (img_rect.x0 + img_rect.x1) / 2,
                (img_rect.y0 + img_rect.y1) / 2
            )
            
            # 计算欧氏距离
            distance = ((keyword_center[0] - img_center[0])**2 + 
                       (keyword_center[1] - img_center[1])**2)**0.5
            
            if distance < min_distance:
                min_distance = distance
                best_image = img_info
    
    # 4. 提取最近的图片
    if best_image and min_distance < 1000:  # 距离阈值
        # 提取图片...
        return image_path
    
    return None
```

### 方案2: 基于Figure编号的定位

```python
def extract_image_by_figure_number(self, doc, page_num: int, keyword: str) -> Optional[Path]:
    """
    通过搜索"Figure X"来定位图片
    """
    page = doc[page_num]
    text = page.get_text("text")
    
    # 搜索关键词附近的"Figure"编号
    # 例如："流程图 (Figure 1)" 或 "Figure 1: 流程图"
    import re
    figure_pattern = r'[Ff]igure\s+(\d+)'
    figure_matches = re.finditer(figure_pattern, text)
    
    # 找到关键词和Figure编号的关联
    # 然后提取对应编号的图片
    ...
```

### 方案3: 基于文本块的定位

```python
def extract_image_by_text_block(self, doc, page_num: int, keyword: str) -> Optional[Path]:
    """
    通过分析文本块和图片的位置关系来定位
    """
    page = doc[page_num]
    
    # 获取所有文本块
    text_blocks = page.get_text("dict")["blocks"]
    
    # 找到包含关键词的文本块
    keyword_block = None
    for block in text_blocks:
        if "lines" in block:
            for line in block["lines"]:
                if keyword in line.get("text", ""):
                    keyword_block = block
                    break
    
    if not keyword_block:
        return None
    
    # 找到在关键词文本块附近的图片块
    # 基于坐标判断
    ...
```

---

## 当前代码位置

- **关键词搜索**: `scripts/image_prompt_test.py` 第 515-592 行
- **图片提取**: `scripts/image_prompt_test.py` 第 594-646 行
- **主流程**: `scripts/image_prompt_test.py` 第 648-700 行

---

## 总结

**当前定位方式**: 
- ✅ 简单快速
- ❌ 不够精确（页面级别）
- ❌ 可能与关键词无关

**建议改进**:
- 使用坐标定位，找到距离关键词最近的图片
- 或使用Figure编号关联
- 提高提取准确度
