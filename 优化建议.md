# 图片Prompt测试工具 - 优化建议

## ✅ 已完成的优化

### 1. 关键词搜索优化
- ✅ 使用中文关键词及其英文对应进行搜索
- ✅ 关键词列表：流程图/Flowchart、技术路线/Technical Roadmap、框架图/Framework Diagram等
- ✅ 如果论文中没有找到这些关键词，自动跳过

### 2. Prompt生成优化
- ✅ 要求生成**极其详细**的prompt
- ✅ 要求描述**每一个细节**：
  - 布局和结构（精确位置、排列、对齐）
  - 视觉元素（每个形状、框、箭头、线条的精确位置和大小）
  - 文本和标签（所有文本内容、位置、字体）
  - 颜色（每个元素的确切颜色）
  - 连接（所有箭头、线条的方向和样式）
  - 样式（线宽、边框样式、填充模式）
  - 间距（精确距离、边距）
  - 背景、字体、整体风格等

## 🚀 进一步优化方向

### 1. 图片提取优化

#### 1.1 多图片选择策略
**当前**：找到关键词后提取第一张符合条件的图片

**优化**：
- 如果页面有多张图片，提取**最大**或**最清晰**的图片
- 优先提取包含关键词的**Figure X**对应的图片（如"Figure 1"、"Figure 2"）
- 如果找到多个关键词，优先提取优先级高的关键词对应的图片

```python
# 建议实现
def extract_best_image(self, doc, page_num, keyword):
    """提取最佳图片：优先选择最大、最清晰的图片"""
    images = self.get_all_images_on_page(doc, page_num)
    # 按尺寸排序，选择最大的
    # 或按清晰度评分
    return best_image
```

#### 1.2 图片质量检测
**优化**：
- 检测图片分辨率（优先选择高分辨率）
- 检测图片清晰度（OCR识别文本清晰度）
- 排除过小的图片（当前已有基本检查，可以更严格）

#### 1.3 关键词上下文匹配
**优化**：
- 不仅搜索关键词，还搜索关键词附近的"Figure"编号
- 例如：找到"流程图"后，搜索附近的"Figure 1"、"Figure 2"等
- 提取对应编号的图片，更准确

### 2. Prompt生成优化

#### 2.1 多轮对话优化
**当前**：单次API调用生成所有prompt

**优化**：
- 第一轮：生成整体描述
- 第二轮：基于第一轮结果，生成更详细的描述
- 第三轮：补充细节和修正

```python
# 建议实现
def generate_detailed_prompts_multi_round(self, image_path):
    """多轮对话生成更详细的prompt"""
    # 第一轮：整体描述
    overview = self.analyze_image_overview(image_path)
    # 第二轮：详细描述
    details = self.analyze_image_details(image_path, overview)
    # 第三轮：补充细节
    final_prompts = self.refine_prompts(image_path, details)
    return final_prompts
```

#### 2.2 结构化Prompt生成
**优化**：
- 要求LLM按结构化格式返回：
  - Layout: {...}
  - Elements: {...}
  - Colors: {...}
  - Connections: {...}
- 然后组合成完整的prompt

#### 2.3 使用更强的模型
**优化**：
- 图生文使用 `google/gemini-2.0-flash-thinking` 或 `anthropic/claude-3.5-sonnet`
- 这些模型能生成更详细、更准确的描述

### 3. 图片生成优化

#### 3.1 多尺寸生成
**优化**：
- 生成多个尺寸的图片（512x512, 1024x1024等）
- 选择与原图尺寸最接近的

#### 3.2 迭代优化
**优化**：
- 第一轮生成后，与原图对比
- 识别差异，生成修正prompt
- 再次生成，逐步接近原图

#### 3.3 使用参考图片
**优化**：
- 如果API支持，将原图作为参考图片传入
- 让模型参考原图生成，效果更好

### 4. 结果评估优化

#### 4.1 自动相似度评分
**优化**：
- 使用图像相似度算法（SSIM、感知哈希等）
- 自动计算生成图片与原图的相似度
- 标记相似度最高的prompt

```python
# 建议实现
def calculate_similarity(self, original_path, generated_path):
    """计算两张图片的相似度"""
    from skimage.metrics import structural_similarity as ssim
    # 计算SSIM分数
    return similarity_score
```

#### 4.2 生成效果排序
**优化**：
- 自动对所有生成的图片进行相似度评分
- 按相似度排序，标记最佳prompt
- 在输出中突出显示最佳结果

### 5. 工作流程优化

#### 5.1 断点续传
**优化**：
- 记录处理进度
- 支持中断后继续处理
- 跳过已处理的论文

#### 5.2 并行处理
**优化**：
- 多线程/多进程并行处理多篇论文
- 提高处理速度

#### 5.3 增量处理
**优化**：
- 支持增量添加新论文
- 自动去重，避免重复处理

### 6. 输出优化

#### 6.1 生成对比报告
**优化**：
- 自动生成HTML对比报告
- 原图与5张生成图片并排显示
- 显示相似度分数
- 标记最佳prompt

#### 6.2 统计分析
**优化**：
- 统计不同prompt的平均相似度
- 分析哪些类型的描述效果更好
- 生成优化建议

### 7. 错误处理优化

#### 7.1 重试机制
**优化**：
- API调用失败自动重试（指数退避）
- 记录失败原因，便于排查

#### 7.2 降级策略
**优化**：
- 如果高质量模型失败，自动降级到备用模型
- 确保流程不中断

## 📊 优先级建议

### 高优先级（立即实施）
1. ✅ **关键词搜索优化** - 已完成
2. ✅ **Prompt详细度优化** - 已完成
3. 🔄 **图片质量检测** - 提高提取准确度
4. 🔄 **相似度评分** - 自动评估生成效果

### 中优先级（后续优化）
1. 多轮对话生成prompt
2. 结构化prompt生成
3. 生成对比报告

### 低优先级（长期优化）
1. 并行处理
2. 迭代优化生成
3. 使用更强的模型

## 🎯 预期效果

实施这些优化后：
- ✅ 图片提取准确度提高（找到正确的流程图）
- ✅ Prompt详细度提高（描述每个细节）
- ✅ 生成图片相似度提高（更接近原图）
- ✅ 自动化程度提高（自动评估和排序）
- ✅ 用户体验改善（清晰的对比报告）

---

**建议先从高优先级优化开始！** 🚀
